#!/usr/bin/env bash
#
# Setup Script
#
# Runs all the needed commands to set up a developer's system to run this app.
# Customize this as your app grows.

# Check for macOS
if [[ ! "$OSTYPE" =~ ^darwin ]]; then
  echo "This script only works on macOS"
  exit 1
fi

# Check for Homebrew
command -v brew >/dev/null 2>&1 || {
  echo "This setup script requires Homebrew, but it was not found on your system."
  echo "Install it using the instructions at https://brew.sh/"
  exit 1
}

# Ensure Node.js is installed
command -v npm >/dev/null 2>&1 || {
  echo "This app requires Node.js to run, but it was not found on your system."
  read -p "Install Node.js with homebrew [y/n]? " -n 1 -r
  echo  # (optional) move to a new line
  if [[ ! $REPLY =~ ^[Yy]$ ]]
  then
    echo "Installation Aborted."
    exit 1
  fi
  echo "Installing node with brew..."
  brew install node
}

# Ensure Watchman is installed
command -v watchman >/dev/null 2>&1 || {
  echo "This app requires Watchman to watch file changes, but it was not found on your system."
  read -p "Install Watchman with homebrew [y/n]? " -n 1 -r
  echo  # (optional) move to a new line
  if [[ ! $REPLY =~ ^[Yy]$ ]]
  then
    echo "Installation Aborted."
    exit 1
  fi
  echo "Installing watchman with brew..."
  brew install watchman
}

# Ensure Yarn is installed
command -v yarn >/dev/null 2>&1 || {
  echo "This app requires Yarn package manager, but it was not found on your system."
  read -p "Install yarn with homebrew [y/n]? " -n 1 -r
  echo  # (optional) move to a new line
  if [[ ! $REPLY =~ ^[Yy]$ ]]
  then
    echo "Installation Aborted."
    exit 1
  fi
  echo "Installing yarn with brew..."
  brew install yarn
}

# Ensure appleSimUtils is installed
command -v applesimutils >/dev/null 2>&1 || {
  echo "This app requires appleSimUtils to run end to end tests, but it was not found on your system."
  read -p "Install appleSimUtils with homebrew [y/n]? " -n 1 -r
  echo  # (optional) move to a new line
  if [[ ! $REPLY =~ ^[Yy]$ ]]
  then
    echo "Installation Aborted."
    exit 1
  fi
  echo "Installing applesimutils with brew..."
  brew tap wix/brew
  brew install applesimutils
}

# Ensure detox-cli is installed
command -v detox >/dev/null 2>&1 || {
  echo "This app requires detox-cli to run end to end tests, but it was not found on your system."
  read -p "Install detox-cli globally with npm [y/n]? " -n 1 -r
  echo  # (optional) move to a new line
  if [[ ! $REPLY =~ ^[Yy]$ ]]
  then
    echo "Installation Aborted."
    exit 1
  fi
  echo "Installing detox globally with npm..."
  npm install -g detox-cli
}

echo "----------------------------------------------------------"
echo "Installing NPM Packages with Yarn"
echo "----------------------------------------------------------"

yarn || { echo "NPM Packages could not be installed!"; exit 1; };

echo "----------------------------------------------------------"
echo "Running tests to verify setup is complete"
echo "----------------------------------------------------------"

yarn test || { exit 1; }

echo "----------------------------------------------------------"
echo "Setup complete!"
echo "----------------------------------------------------------"

echo "To run the app on Expo:"
echo "yarn start"